language: android
dist: trusty
jdk: oraclejdk8
env:
  global:
  - ANDROID_TARGET=android-26
  - EMU_API_LEVEL=android-24
  - ANDROID_TAG=google_apis
  - ANDROID_ABI=armeabi-v7a
android:
  components:
  - build-tools-26.0.1
  - build-tools-24.0.1
  # - build-tools-22.0.1
  - "$ANDROID_TARGET"
  - "$EMU_API_LEVEL"
  - extra-android-support
  - extra-google-m2repository
  - extra-android-m2repository
  - sys-img-$ANDROID_ABI-android-24
licenses:
- 'android-sdk-license-.+'
- 'google-gdk-license-.+'
- 'android-sdk-preview-license-.+'

branches:
  only:
    - main

before_install:
- cd code
- chmod +x gradlew
- yes | sdkmanager "platforms;android-26"
- export GRADLE_HOME=$PWD/gradle-5.3
- export PATH=$GRADLE_HOME/bin:$PATH
# - gradle -v
- echo no | android create avd --force -n test -t $EMU_API_LEVEL --abi $ANDROID_ABI
- openssl aes-256-cbc -K $encrypted_f761570c4ae9_key -iv $encrypted_f761570c4ae9_iv
  -in google-services.json.enc -out google-services.json -d
# also decrypt in app
- cd app
- openssl aes-256-cbc -K $encrypted_f761570c4ae9_key -iv $encrypted_f761570c4ae9_iv
  -in google-services.json.enc -out google-services.json -d
- cd ../
- emulator -avd test -no-window &
- android-wait-for-emulator
- adb shell input keyevent 82 &

script:
- ./gradlew build connectedCheck --stacktrace